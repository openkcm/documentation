---
authors:
  - Aysan
---

## Persona
**MongoDB Service** - A database service running within the Apeiro Platform Mesh that needs to encrypt/decrypt data using OpenKCM's Crypto Layer. MongoDB operates without customer involvement in key management and uses OpenKCM's internal key hierarchy for transparent encryption.

## Overview

As a MongoDB service running in Platform Mesh, I need to request encryption keys from OpenKCM's Crypto Layer to encrypt database records. I don't require customer-managed keys (CMK) - instead, I use OpenKCM's internal key management system for automatic, transparent encryption without customer key configuration.

## User Stories

### Story 1: MongoDB Registers with OpenKCM Crypto Service
**As a** MongoDB service instance  
**I want to** register with OpenKCM Crypto Layer  
**So that** I can request encryption keys for data protection operations  

**Technical Journey:**
1. **Service Deployment**: I get deployed in Platform Mesh for a tenant
2. **Automatic Registration**: Platform Mesh automatically registers me with OpenKCM Crypto Service
   - Service identity: `mongodb-cluster-tenant-a`
   - Service type: `database`
   - Tenant context: `tenant-a`
3. **Certificate Provisioning**: I receive mTLS certificates from Platform Mesh
   - Client certificate for Crypto Service authentication
   - Certificate scoped to my tenant and service permissions
4. **Connection Establishment**: I establish persistent connection to Crypto Service
   - TLS 1.3 with mutual authentication
   - Connection pooling for performance
5. **Service Validation**: Crypto Service confirms my registration
   - Validates certificate and service identity
   - Authorizes me for tenant-a encryption operations

**Requirements:**
- Automatic registration without manual configuration
- mTLS authentication setup through Platform Mesh
- Connection establishment within 30 seconds
- Tenant isolation enforced by certificates

### Story 2: MongoDB Requests Encryption Key for Data Storage
**As a** MongoDB service  
**I want to** request encryption keys from Crypto Layer  
**So that** I can encrypt database records transparently  

**Technical Journey:**
1. **Data Write Operation**: Application stores customer data
   ```json
   {
     "tenant_id": "tenant-a",
     "collection": "orders",
     "document": {
       "order_id": "ORD-12345",
       "customer_name": "Alice Smith",
       "credit_card": "4532-****-****-9876"
     }
   }
   ```

2. **Key Request via KMIP**: I request encryption key from Crypto Service
   ```
   KMIP Request:
   - Operation: Create Symmetric Key
   - Tenant: tenant-a
   - Service: mongodb-cluster-tenant-a
   - Usage: encrypt
   ```

3. **Internal Key Derivation**: Crypto Service processes request
   - Uses internal L2 tenant key (automatically managed by OpenKCM)
   - Derives L4 ephemeral key for this encryption operation
   - No customer L1 key required - fully internal key management

4. **Data Encryption**: I encrypt sensitive fields
   ```python
   # Get encryption key from Crypto Service
   encryption_key = kmip_client.get_key(tenant_id="tenant-a")
   
   # Encrypt sensitive data
   encrypted_doc = {
     "order_id": "ORD-12345",  # Not encrypted (for indexing)
     "customer_name": encrypt_aes256(encryption_key, "Alice Smith"),
     "credit_card": encrypt_aes256(encryption_key, "4532-****-****-9876")
   }
   
   # Store encrypted document
   db.orders.insert_one(encrypted_doc)
   
   # Discard ephemeral key
   secure_delete(encryption_key)
   ```

5. **Transparent Operation**: Encryption happens automatically
   - No application code changes required
   - No customer key management needed
   - Tenant isolation maintained through service authentication

**Requirements:**
- Key requests complete within 50ms
- Each encryption uses fresh ephemeral key
- Tenant isolation enforced (only tenant-a keys accessible)
- No persistent key storage in MongoDB
- Automatic encryption for all write operations

### Story 3: MongoDB Decrypts Data for Read Operations
**As a** MongoDB service  
**I want to** decrypt stored data using keys from Crypto Layer  
**So that** applications can access readable customer data  

**Technical Journey:**
1. **Data Read Request**: Application queries for customer data
   ```json
   {
     "tenant_id": "tenant-a",
     "collection": "orders", 
     "query": {"order_id": "ORD-12345"}
   }
   ```

2. **Retrieve Encrypted Data**: I fetch encrypted document from storage
   ```json
   {
     "order_id": "ORD-12345",
     "customer_name": "ENCRYPTED_BLOB_AAA123",
     "credit_card": "ENCRYPTED_BLOB_BBB456"
   }
   ```

3. **Decryption Key Request**: I request decryption key via KMIP
   ```
   KMIP Request:
   - Operation: Get Symmetric Key
   - Tenant: tenant-a
   - Service: mongodb-cluster-tenant-a
   - Usage: decrypt
   ```

4. **Data Decryption**: I decrypt the sensitive fields
   ```python
   # Get decryption key from Crypto Service
   decryption_key = kmip_client.get_key(tenant_id="tenant-a", usage="decrypt")
   
   # Decrypt sensitive fields
   readable_doc = {
     "order_id": "ORD-12345",
     "customer_name": decrypt_aes256(decryption_key, encrypted_doc["customer_name"]),
     "credit_card": decrypt_aes256(decryption_key, encrypted_doc["credit_card"])
   }
   
   # Return readable data to application
   return readable_doc
   
   # Discard decryption key
   secure_delete(decryption_key)
   ```

5. **Performance Optimization**: I cache keys briefly for performance
   - Keys cached for maximum 5 minutes
   - Batch operations reuse same key when possible
   - Connection pooling reduces latency

**Requirements:**
- Decryption operations complete within 20ms after key retrieval
- Only authorized tenant data is accessible
- Keys securely deleted after use
- Minimal performance impact on read operations

### Story 4: Handle Internal Key Rotation
**As a** MongoDB service  
**I want to** adapt to OpenKCM internal key rotations  
**So that** I continue operating seamlessly when keys are rotated  

**Technical Journey:**
1. **Key Rotation Event**: OpenKCM rotates internal L2 tenant key
   ```json
   {
     "event": "key_rotation",
     "tenant_id": "tenant-a", 
     "level": "L2_internal",
     "effective_time": "2026-01-15T12:00:00Z"
   }
   ```

2. **Automatic Adaptation**: I handle rotation transparently
   - Clear any cached keys for tenant-a
   - New encryption requests get keys from new L2 key
   - Old data remains accessible during transition period

3. **Continued Operations**: Encryption/decryption continues working
   - New data encrypted with keys from rotated L2 key
   - Existing data decryptable with appropriate key versions
   - No service interruption or application impact

**Requirements:**
- Zero downtime during key rotations
- Automatic cache invalidation when keys rotate
- Backward compatibility for reading old encrypted data
- No manual intervention required

## Technical Flow

```
MongoDB Service → Crypto Service Authentication (mTLS)
        ↓
MongoDB → Request encryption key (KMIP)
        ↓
Crypto Service → Derive ephemeral key from internal L2 key
        ↓
MongoDB → Encrypt data with ephemeral key
        ↓
Encrypted data stored in database
        ↓
For reads: MongoDB requests decryption key and decrypts data
```

## Requirements

### Functional Requirements:
- **REQ-001**: MongoDB must authenticate with Crypto Service using mTLS certificates
- **REQ-002**: Crypto Service must provide encryption keys using internal key hierarchy
- **REQ-003**: MongoDB must encrypt sensitive database fields automatically
- **REQ-004**: System must maintain tenant isolation without customer key management
- **REQ-005**: Key operations must work without customer CMK configuration

### Performance Requirements:
- **REQ-006**: Key requests complete within 50ms (95th percentile)
- **REQ-007**: Database performance impact stays under 15%
- **REQ-008**: Connection establishment completes within 30 seconds
- **REQ-009**: System scales to 10,000+ key operations per second

### Security Requirements:
- **REQ-010**: Ephemeral keys never persisted by MongoDB
- **REQ-011**: Tenant isolation enforced through service authentication
- **REQ-012**: All key operations logged for audit compliance
- **REQ-013**: Internal key rotations handled transparently

## Success Criteria

### Operational Success:
- ✅ MongoDB encrypts data automatically without customer key setup
- ✅ Tenant isolation maintained using internal OpenKCM key management
- ✅ Key requests meet performance requirements
- ✅ Internal key rotations handled seamlessly

### Security Success:
- ✅ All sensitive data encrypted at rest using OpenKCM-managed keys
- ✅ Cross-tenant data access prevented
- ✅ Ephemeral keys used for each operation
- ✅ Complete audit trail for all encryption operations

### Integration Success:
- ✅ Zero application code changes required for encryption
- ✅ MongoDB service integrates transparently with Crypto Layer
- ✅ Performance impact within acceptable limits
- ✅ System operates reliably without customer key management

## Business Value

- **Transparent Encryption**: Data protection without customer key management complexity
- **Zero Configuration**: Automatic encryption setup through Platform Mesh integration
- **Tenant Isolation**: Each tenant's data encrypted with isolated keys
- **Performance**: Minimal impact on database operations
- **Compliance**: Encrypted data storage meets regulatory requirements
- **Operational Simplicity**: No customer key management overhead