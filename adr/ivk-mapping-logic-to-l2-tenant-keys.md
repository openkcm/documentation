# ADR-302: IVK Mapping Logic to L2 Tenant Keys

| Status | Date | Document Type |
| :--- | :--- | :--- |
| **Active** | 2026-01-16 | Architecture Design Record |

## Context
In the OpenKCM layered hierarchy, the **L2 Tenant Key** is the primary mathematical silo. Originally, the L2 was wrapped directly by the customer's external **L1 Root Key**. While this provides absolute sovereignty, it introduces two operational bottlenecks:
* **High Latency:** Every time a Crypto (Krypton) node needs to unwrap an L2 (e.g., after a cache miss or restart), it must perform a cross-network call to the customer’s cloud KMS.
* **MasterKey Rigidity:** If we used the system MasterKey to wrap L2s directly, rotating the MasterKey would require re-wrapping every single L2 in the database, a massive and risky operation.

We require an intermediate layer—the **Internal Versioned Key (IVK)**—to act as the high-velocity "Active Wrapper" for L2 keys within a specific region.

## Decision
We will implement an **IVK Mapping Logic** that decouples the L2 Tenant Key from both the MasterKey and the External L1 during routine operations.



## The Mapping Architecture
The Crypto (Krypton) will maintain a regional **IVK Registry**. Every L2 Tenant Key will transition from a single-wrapped state to a **Dual-Wrapped state**:

* **Sovereign Binding (L1 → L2):** The L2 key is wrapped by the Customer's L1. This is the "Recovery Path" used only when the IVK is unavailable or during initial onboarding.
* **Active Binding (IVK → L2):** The L2 key is wrapped by the current Regional IVK. This is the "Hot Path" used for 99% of internal operations.

## IVK Lifecycle & Versioning
* **Scope:** One set of IVKs per Regional Crypto (Krypton) cluster.
* **Persistence:** IVKs are generated by the Core, wrapped by the MasterKey, and stored in the **Key Storage Interface (KSI)**.
* **Rotation:** IVKs are rotated on a defined schedule (e.g., every 30 days). When a new IVK version is generated, it becomes the `ACTIVE` version for all new L2 mappings.

## Mapping Resolution Logic
When the Crypto (Krypton) receives a request for a Tenant's L2 key:
* **Cache Check:** The Core looks for the "Green" (plaintext) L2 in `mlock` memory.
* **IVK Unwrap (Hot Path):** If not in memory, the Core retrieves the `Active_Binding` blob. It unwraps the L2 using the IVK version specified in the blob's metadata.
* **L1 Unwrap (Fallback Path):** If the IVK binding is missing or corrupted, the Core initiates a recursive unseal by calling the **Customer's L1 KMS** to unwrap the `Sovereign_Binding` blob.
* **Self-Healing Re-wrap:** Upon a successful L1 unwrap, the Core immediately generates a new `Active_Binding` for that L2 using the current active IVK.

## Mapping Cardinality
* **IVK to L2:** One IVK version wraps multiple L2 Tenant Keys (1:N).
* **L2 to IVK:** An L2 key is only wrapped by the specific IVK version that was active at the time of its last unwrap/onboarding.

## Consequences

### Positive (Pros)
* **Performance:** Unwrapping an L2 via a local IVK (wrapped by the already-unsealed MasterKey) takes microseconds, compared to 200–500ms for an external L1 call.
* **Lazy Rotation:** We can rotate the regional IVK without touching the L2 keys immediately. L2s are "Lazily" re-wrapped into the new IVK version only when they are next accessed.
* **Infrastructure Independence:** The region can continue to function and restart (provided the MasterKey is unsealed) even if the customer's cloud KMS is experiencing a temporary outage.

### Negative (Cons) & Mitigations
* **Mapping Sprawl:** We must track which IVK version wraps which L2.
    * **Mitigation:** The **Encrypted Object Header** in the KSI record explicitly stores the `ivk_version_id` alongside the wrapped L2 blob.
* **Cryptographic Erasure Complexity:** Deleting an IVK renders all L2s wrapped by it inaccessible.
    * **Mitigation:** The system prevents the deletion of a `DEPRECATED` IVK until all associated L2s have been migrated to a newer version.

## References
* [ADR-102: Tiered Envelope Encryption](tiered-envelope-encryption-model.md)
* [ADR-301: The IVK (Internal Versioned Key) Architecture](ivk-architecture.md)
* [ACD-301: The Layered Key Hierarchy](../acd/layered-key-hierarchy-(L1→L4).md)